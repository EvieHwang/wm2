name: Deploy

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    # Only run after CI passes
    needs: []
    if: github.ref == 'refs/heads/main'

    permissions:
      id-token: write  # For OIDC
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Upload source to S3
        run: |
          cd backend
          zip -r /tmp/backend-source.zip . \
            -x ".aws-sam/*" \
            -x "data/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".pytest_cache/*" \
            -x "venv/*" \
            -x "*/__pycache__/*"
          aws s3 cp /tmp/backend-source.zip s3://wm2-asrs-classifier-frontend/codebuild/backend-source.zip

      - name: Trigger CodeBuild
        id: codebuild
        run: |
          BUILD_ID=$(aws codebuild start-build \
            --project-name asrs-classifier-container-build \
            --query 'build.id' \
            --output text)
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Started CodeBuild: $BUILD_ID"

      - name: Wait for CodeBuild
        run: |
          BUILD_ID="${{ steps.codebuild.outputs.build_id }}"
          echo "Waiting for build $BUILD_ID to complete..."

          while true; do
            STATUS=$(aws codebuild batch-get-builds \
              --ids "$BUILD_ID" \
              --query 'builds[0].buildStatus' \
              --output text)

            echo "Build status: $STATUS"

            if [ "$STATUS" = "SUCCEEDED" ]; then
              echo "Build succeeded!"
              break
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "FAULT" ] || [ "$STATUS" = "STOPPED" ] || [ "$STATUS" = "TIMED_OUT" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi

            sleep 30
          done

      - name: Update Lambda function
        run: |
          FUNCTION_NAME="asrs-classifier-ClassifierFunction-uW9uX1CYlKvc"
          IMAGE_URI="070840362692.dkr.ecr.us-west-2.amazonaws.com/asrs-classifier:latest"

          echo "Updating Lambda function..."
          aws lambda update-function-code \
            --function-name $FUNCTION_NAME \
            --image-uri $IMAGE_URI

          echo "Waiting for update to complete..."
          aws lambda wait function-updated --function-name $FUNCTION_NAME

          echo "Publishing new version..."
          VERSION=$(aws lambda publish-version \
            --function-name $FUNCTION_NAME \
            --description "Deployed via GitHub Actions - ${{ github.sha }}" \
            --query 'Version' \
            --output text)

          echo "Updating alias to version $VERSION..."
          aws lambda update-alias \
            --function-name $FUNCTION_NAME \
            --name live \
            --function-version $VERSION

          echo "Setting provisioned concurrency..."
          aws lambda put-provisioned-concurrency-config \
            --function-name $FUNCTION_NAME \
            --qualifier $VERSION \
            --provisioned-concurrent-executions 1

          echo "Deployment complete! Version: $VERSION"

      - name: Verify deployment
        run: |
          echo "Waiting for provisioned concurrency..."
          sleep 90

          echo "Testing API endpoint..."
          RESPONSE=$(curl -s -X POST \
            "https://zatpg0rga1.execute-api.us-west-2.amazonaws.com/prod/classify" \
            -H "Content-Type: application/json" \
            -d '{"description":"test product"}')

          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"classification"'; then
            echo "Deployment verified successfully!"
          else
            echo "Warning: Unexpected response from API"
          fi
